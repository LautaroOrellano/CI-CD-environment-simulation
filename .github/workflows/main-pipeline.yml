name: CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:

  # ---------- CI Reusable ----------
  call-ci:
    uses: ./.github/workflows/ci.yml
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

  # ---------- Deploy a Staging ----------
  deploy-staging:
    needs: call-ci
    uses: ./.github/workflows/deploy-staging.yml
    with:
      # Inputs obligatorios del workflow reusable (pueden ser literales o placeholders)
      gcp_project_id: "staging-project"       
      staging_vm_ip: "dummy"
      staging_vm_user: "dummy"
      staging_vm_key: "dummy"
    secrets:
      # Secrets reales
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      STAGING_VM_IP: ${{ secrets.STAGING_VM_IP }}
      STAGING_VM_USER: ${{ secrets.STAGING_VM_USER }}
      STAGING_VM_KEY: ${{ secrets.STAGING_VM_KEY }}

  # ---------- Integration Test + DAST ----------
  integration-dast:
    needs: deploy-staging
    uses: ./.github/workflows/integration-test.yml
    with:
      gcp_project_id: "dummy"   
    secrets:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}

# ---------- Deploy a Producción (manual) ----------
# NOTA: no se puede llamar con `uses:` si es workflow_dispatch
# Para deploy a producción, ejecutá directamente deploy-production.yml desde GitHub Actions
